<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>Kalendářní kalkulátor - Rozšířený</title>
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #8B7355 0%, #6B5B47 25%, #4A4A3A 50%, #5D4E37 75%, #8B7355 100%);
            --bg-container: linear-gradient(145deg, rgba(139, 118, 76, 0.8) 0%, rgba(101, 67, 33, 0.9) 100%);
            --border-main: rgba(205, 186, 150, 0.4);
            --text-primary: #F5E6D3;
            --text-accent: #CDBA96;
            --control-bg: linear-gradient(145deg, rgba(15, 15, 15, 0.9) 0%, rgba(35, 35, 35, 0.8) 100%);
            --control-border: rgba(60, 60, 60, 0.8);
            --button-bg: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 30%, #0f0f0f 70%, #1a1a1a 100%);
        }
        .theme-blue {
            --bg-primary: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 25%, #1e40af 50%, #2563eb 75%, #1e3a8a 100%);
            --bg-container: linear-gradient(145deg, rgba(30, 58, 138, 0.8) 0%, rgba(37, 99, 235, 0.9) 100%);
            --border-main: rgba(147, 197, 253, 0.4);
            --text-primary: #dbeafe;
            --text-accent: #93c5fd;
        }
        .theme-green {
            --bg-primary: linear-gradient(135deg, #14532d 0%, #16a34a 25%, #15803d 50%, #22c55e 75%, #14532d 100%);
            --bg-container: linear-gradient(145deg, rgba(20, 83, 45, 0.8) 0%, rgba(21, 128, 61, 0.9) 100%);
            --border-main: rgba(134, 239, 172, 0.4);
            --text-primary: #dcfce7;
            --text-accent: #86efac;
        }
        .theme-purple {
            --bg-primary: linear-gradient(135deg, #581c87 0%, #a855f7 25%, #7c3aed 50%, #8b5cf6 75%, #581c87 100%);
            --bg-container: linear-gradient(145deg, rgba(88, 28, 135, 0.8) 0%, rgba(124, 58, 237, 0.9) 100%);
            --border-main: rgba(196, 181, 253, 0.4);
            --text-primary: #f3e8ff;
            --text-accent: #c4b5fd;
        }
        .theme-red {
            --bg-primary: linear-gradient(135deg, #7f1d1d 0%, #dc2626 25%, #b91c1c 50%, #ef4444 75%, #7f1d1d 100%);
            --bg-container: linear-gradient(145deg, rgba(127, 29, 29, 0.8) 0%, rgba(185, 28, 28, 0.9) 100%);
            --border-main: rgba(252, 165, 165, 0.4);
            --text-primary: #fef2f2;
            --text-accent: #fca5a5;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: Arial, sans-serif; 
            background: var(--bg-primary); 
            min-height: 100vh; 
            padding: 10px; 
            color: var(--text-primary); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); 
            overflow-x: hidden; 
        }
        
        .container { 
            max-width: 100%; 
            width: 100%; 
            margin: 0 auto; 
            background: var(--bg-container); 
            border-radius: 20px; 
            padding: 20px; 
            border: 2px solid var(--border-main); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); 
            position: relative; 
        }
        
        .menu-container { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 100; 
        }
        
        .menu-button { 
            width: 44px; 
            height: 44px; 
            border-radius: 50%; 
            background: var(--button-bg); 
            border: 2px solid var(--control-border); 
            color: var(--text-primary); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 20px; 
            font-weight: bold; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9); 
            -webkit-user-select: none; 
            user-select: none; 
            z-index: 101; 
        }
        
        .menu-button:active { 
            transform: scale(0.95); 
            background: rgba(50, 50, 50, 0.8); 
        }
        
        .menu-dropdown { 
            position: absolute; 
            top: 50px; 
            right: 0; 
            min-width: 320px; 
            background: var(--control-bg); 
            border: 2px solid var(--control-border); 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7); 
            opacity: 0; 
            visibility: hidden; 
            transform: translateY(-10px); 
            transition: all 0.3s ease; 
            max-height: 70vh; 
            overflow-y: auto; 
            display: none; 
        }
        
        .menu-dropdown.show { 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0); 
            display: block; 
        }
        
        .menu-section { 
            padding: 8px 0; 
            border-bottom: 1px solid rgba(80, 80, 80, 0.3); 
        }
        
        .menu-section:last-child { 
            border-bottom: none; 
        }
        
        .menu-section-title { 
            padding: 8px 16px; 
            color: var(--text-accent); 
            font-size: 12px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        
        .menu-item, .theme-item { 
            padding: 12px 16px; 
            color: var(--text-primary); 
            display: flex; 
            align-items: center; 
            font-size: 15px; 
            font-weight: 500; 
            cursor: pointer; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); 
            -webkit-user-select: none; 
            user-select: none; 
            min-height: 44px; 
        }
        
        .menu-item:active, .theme-item:active { 
            background: rgba(60, 60, 60, 0.6); 
            color: var(--text-accent); 
        }
        
        .menu-item.has-submenu { 
            justify-content: space-between; 
        }
        
        .menu-item.has-submenu::after { 
            content: "▶"; 
            font-size: 12px; 
            color: var(--text-accent); 
        }
        
        .submenu { 
            display: none; 
            background: rgba(25, 25, 25, 0.95); 
            border-left: 3px solid var(--border-main); 
            margin-top: 8px; 
            border-radius: 8px; 
        }
        
        .submenu.show { 
            display: block; 
        }
        
        .submenu .menu-item { 
            padding-left: 24px; 
            font-size: 14px; 
        }
        
        .theme-item { 
            gap: 10px; 
        }
        
        .theme-preview { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            flex-shrink: 0; 
        }
        
        .theme-bronze .theme-preview { 
            background: linear-gradient(45deg, #8B7355, #CDBA96); 
        }
        
        .theme-blue .theme-preview { 
            background: linear-gradient(45deg, #3b82f6, #93c5fd); 
        }
        
        .theme-green .theme-preview { 
            background: linear-gradient(45deg, #16a34a, #86efac); 
        }
        
        .theme-purple .theme-preview { 
            background: linear-gradient(45deg, #a855f7, #c4b5fd); 
        }
        
        .theme-red .theme-preview { 
            background: linear-gradient(45deg, #dc2626, #fca5a5); 
        }
        
        .header { 
            text-align: center; 
            margin-bottom: 25px; 
            margin-top: 15px; 
            padding-right: 60px; 
        }
        
        .header h1 { 
            font-size: 22px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: var(--text-primary); 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); 
            line-height: 1.2; 
        }
        
        .header p { 
            color: var(--text-primary); 
            font-size: 14px; 
            font-weight: 400; 
            font-style: italic; 
            opacity: 0.9; 
        }
        
        .display { 
            background: var(--control-bg); 
            border-radius: 18px; 
            padding: 20px; 
            margin-bottom: 20px; 
            min-height: 80px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
            border: 2px solid var(--control-border); 
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6); 
        }
        
        .display.result { 
            background: linear-gradient(145deg, rgba(20, 60, 20, 0.9) 0%, rgba(30, 80, 30, 0.8) 100%); 
            border-color: rgba(100, 150, 100, 0.6); 
        }
        
        .display.error { 
            background: linear-gradient(145deg, rgba(60, 20, 20, 0.9) 0%, rgba(80, 30, 30, 0.8) 100%); 
            border-color: rgba(150, 100, 100, 0.6); 
        }
        
        .display-text { 
            font-size: 16px; 
            font-weight: 500; 
            line-height: 1.4; 
            word-wrap: break-word; 
        }
        
        .calculator-view { 
            display: none; 
        }
        
        .calculator-view.active { 
            display: block; 
        }
        
        .input-section { 
            margin-bottom: 20px; 
        }
        
        .input-label { 
            display: block; 
            margin-bottom: 12px; 
            font-weight: 600; 
            color: var(--text-primary); 
            font-size: 15px; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); 
        }
        
        .date-input-container { 
            margin-bottom: 18px; 
        }
        
        .date-input, .number-input, .location-input { 
            width: 100%; 
            padding: 18px; 
            border: 2px solid var(--control-border); 
            border-radius: 12px; 
            background: var(--control-bg); 
            color: var(--text-primary); 
            font-size: 18px; 
            text-align: center; 
            outline: none; 
            font-weight: 500; 
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6); 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); 
            -webkit-appearance: none; 
            min-height: 56px; 
        }
        
        .date-input:focus, .number-input:focus, .location-input:focus { 
            border-color: var(--border-main); 
        }
        
        .date-input::placeholder, .number-input::placeholder, .location-input::placeholder { 
            color: rgba(180, 180, 180, 0.7); 
            font-weight: 400; 
        }
        
        .format-hint { 
            font-size: 13px; 
            color: var(--text-accent); 
            text-align: center; 
            margin-top: 8px; 
            font-style: italic; 
            line-height: 1.3; 
        }
        
        .calculate-btn { 
            width: 100%; 
            padding: 18px; 
            background: var(--button-bg); 
            color: var(--text-primary); 
            border: 2px solid var(--control-border); 
            border-radius: 15px; 
            font-size: 17px; 
            font-weight: 700; 
            cursor: pointer; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4); 
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9); 
            -webkit-user-select: none; 
            user-select: none; 
            min-height: 56px; 
            -webkit-appearance: none; 
            margin-bottom: 15px; 
        }
        
        .calculate-btn:active { 
            transform: scale(0.98); 
        }
        
        .examples { 
            margin-top: 20px; 
            background: var(--control-bg); 
            border-radius: 15px; 
            padding: 18px; 
            border: 1px solid var(--control-border); 
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6); 
        }
        
        .examples h3 { 
            font-size: 16px; 
            margin-bottom: 12px; 
            color: var(--text-accent); 
            font-weight: 600; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); 
        }
        
        .examples ul { 
            list-style: none; 
            font-size: 14px; 
            line-height: 1.4; 
        }
        
        .examples li { 
            margin-bottom: 8px; 
            color: var(--text-primary); 
            font-weight: 400; 
            opacity: 0.9; 
            cursor: pointer; 
            padding: 8px 4px; 
            border-radius: 6px; 
            -webkit-user-select: none; 
            user-select: none; 
            min-height: 44px; 
            display: flex; 
            align-items: center; 
        }
        
        .examples li:active { 
            color: var(--text-accent); 
            background: rgba(255, 255, 255, 0.1); 
        }
        
        .examples li::before { 
            content: "→ "; 
            color: var(--text-accent); 
            font-weight: 700; 
            margin-right: 8px; 
        }
        
        .loading { 
            display: inline-block; 
            width: 18px; 
            height: 18px; 
            border: 2px solid rgba(245, 230, 211, 0.3); 
            border-radius: 50%; 
            border-top-color: var(--text-primary); 
            animation: spin 1s linear infinite; 
            margin-right: 8px; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
                
        .input-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 18px; 
        }
        
        .input-col { 
            flex: 1; 
        }
        
        .back-button {
            width: 100%;
            padding: 12px;
            background: var(--control-bg);
            color: var(--text-accent);
            border: 2px solid var(--control-border);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            margin-bottom: 20px;
            -webkit-user-select: none; 
            user-select: none;
        }
        
        .back-button:active { 
            transform: scale(0.98); 
        }
        
        @media (max-width: 480px) {
            body { padding: 5px; }
            .container { padding: 15px; border-radius: 15px; }
            .header h1 { font-size: 20px; }
            .date-input, .number-input, .location-input { font-size: 16px; padding: 16px; }
            .calculate-btn { font-size: 16px; padding: 16px; }
            .menu-dropdown { min-width: 320px; right: -10px; max-width: calc(100vw - 40px); }
            .input-row { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="menu-container">
            <div class="menu-button" id="menuButton">⋮</div>
            <div class="menu-dropdown" id="menuDropdown">
                <div class="menu-section">
                    <div class="menu-item" id="dayOfWeekMenu">📅 Den v týdnu</div>
                    <div class="menu-item" id="versionButton">Kalendářní kalkulátor v4.0</div>
                    <div class="menu-item has-submenu" id="calculatorsMenu">🧮 Další výpočty</div>
                    <div class="submenu" id="calculatorsSubmenu">
                        <div class="menu-item" data-calculator="year-finder">🔍 Hledač roků</div>
                        <div class="menu-item" data-calculator="calendar-converter">🔄 Převod kalendářů</div>
                        <div class="menu-item" data-calculator="easter">🥚 Velikonoce</div>
                        <div class="menu-item" data-calculator="moon-phase">🌙 Fáze Měsíce</div>
                        <div class="menu-item" data-calculator="date-math">➕ Kalendářní aritmetika</div>
                    </div>
                    <div class="menu-item has-submenu" id="astronomyMenu">🌟 Astronomické výpočty</div>
                    <div class="submenu" id="astronomySubmenu">
                        <div class="menu-item" data-calculator="sun-events">☀️ Sluneční události</div>
                        <div class="menu-item" data-calculator="planet-positions">🪐 Pozice planet</div>
                        <div class="menu-item" data-calculator="eclipses">🌑 Zatmění</div>
                        <div class="menu-item" data-calculator="sidereal-time">⏰ Hvězdný čas</div>
                    </div>
                </div>
                <div class="menu-section">
                    <div class="menu-section-title">Barevná témata</div>
                    <div class="theme-item theme-bronze" data-theme="">
                        <div class="theme-preview"></div>
                        Bronzové (výchozí)
                    </div>
                    <div class="theme-item theme-blue" data-theme="theme-blue">
                        <div class="theme-preview"></div>
                        Modré
                    </div>
                    <div class="theme-item theme-green" data-theme="theme-green">
                        <div class="theme-preview"></div>
                        Zelené
                    </div>
                    <div class="theme-item theme-purple" data-theme="theme-purple">
                        <div class="theme-preview"></div>
                        Fialové
                    </div>
                    <div class="theme-item theme-red" data-theme="theme-red">
                        <div class="theme-preview"></div>
                        Červené
                    </div>
                </div>
                <div class="menu-section">
                    <div class="menu-item" data-link="https://claude.ai">Created by Claude AI</div>
                    <div class="menu-item" data-link="https://kalendar.beda.cz/kalendar-rozcestnik">Více o kalendářích</div>
                </div>
            </div>
        </div>

        <!-- Day of Week Calculator -->
        <div id="dayOfWeekCalculator" class="calculator-view active">
            <div class="header">
                <h1>📅 Den v týdnu</h1>
                <p>Zjistěte den v týdnu pro jakékoliv datum v historii</p>
            </div>
            <div id="display" class="display">
                <div class="display-text">Místo pro výsledek</div>
            </div>
            <div class="input-section">
                <label class="input-label" for="dateInput">Zadejte datum:</label>
                <div class="date-input-container">
                    <input type="text" id="dateInput" class="date-input" placeholder="1.1.1 nebo 15.3.44 nebo 01031989" inputmode="numeric" maxlength="15">
                    <div class="format-hint">Formáty: 1.1.1 • 15.3.44 • 1989 • 1/3/1989 • 01031989</div>
                </div>
            </div>
            <button id="calculateBtn" class="calculate-btn">Vypočítat</button>

            <div class="examples">
                <h3>💡 Vyzkoušejte:</h3>
                <ul>
                    <li data-date="1.1.1">1.1.1 - začátek našeho letopočtu</li>
                    <li data-date="15.3.044">15.3.44 - zavraždění Julia Caesara</li>
                    <li data-date="4.10.1582">4.10.1582 - poslední den juliánského kalendáře</li>
                    <li data-date="15.10.1582">15.10.1582 - první den gregoriánského kalendáře</li>
                    <li data-date="8.10.1582">8.10.1582 - neexistující datum!</li>
                    <li data-date="1.1.2000">1.1.2000 - začátek nového tisíciletí</li>
                </ul>
            </div>
        </div>

        <!-- Year Finder Calculator -->
        <div id="yearFinderCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🔍 Hledač roků</h1>
                <p>Najděte roky pro určitou kombinaci dne, měsíce a dne v týdnu</p>
            </div>
            <div id="yearFinderDisplay" class="display">
                <div class="display-text">Nastavte parametry a zobrazte vyhovující roky</div>
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="input-label">Den v měsíci:</label>
                    <input type="number" id="yearFinderDay" class="number-input" placeholder="1-31" min="1" max="31">
                </div>
                <div class="input-col">
                    <label class="input-label">Měsíc:</label>
                    <input type="number" id="yearFinderMonth" class="number-input" placeholder="1-12" min="1" max="12">
                </div>
            </div>
            <div class="input-section">
                <label class="input-label">Den v týdnu:</label>
                <select id="yearFinderDayOfWeek" class="date-input">
                    <option value="">Vyberte den</option>
                    <option value="1">Pondělí</option>
                    <option value="2">Úterý</option>
                    <option value="3">Středa</option>
                    <option value="4">Čtvrtek</option>
                    <option value="5">Pátek</option>
                    <option value="6">Sobota</option>
                    <option value="0">Neděle</option>
                </select>
            </div>
            <button id="yearFinderBtn" class="calculate-btn">Najít roky</button>
        </div>

        <!-- Calendar Converter -->
        <div id="calendarConverterCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🔄 Převod kalendářů</h1>
                <p>Převod mezi gregoriánským a juliánským kalendářem</p>
            </div>
            <div id="converterDisplay" class="display">
                <div class="display-text">Zadejte datum pro převod mezi kalendáři</div>
            </div>
            <div class="input-section">
                <label class="input-label">Datum (DD.MM.RRRR):</label>
                <input type="text" id="converterDate" class="date-input" placeholder="15.10.1582" inputmode="numeric">
            </div>
            <div class="input-section">
                <label class="input-label">Typ kalendáře:</label>
                <select id="converterType" class="date-input">
                    <option value="gregorian">Gregoriánský → Juliánský</option>
                    <option value="julian">Juliánský → Gregoriánský</option>
                </select>
            </div>
            <button id="converterBtn" class="calculate-btn">Převést</button>
        </div>

        <!-- Easter Calculator -->
        <div id="easterCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🥚 Velikonoce</h1>
                <p>Výpočet data Velikonoční neděle a souvisejících svátků</p>
            </div>
            <div id="easterDisplay" class="display">
                <div class="display-text">Zadejte rok pro výpočet velikonočních svátků</div>
            </div>
            <div class="input-section">
                <label class="input-label">Rok:</label>
                <input type="number" id="easterYear" class="number-input" placeholder="2025" min="1" max="9999">
            </div>
            <button id="easterBtn" class="calculate-btn">Vypočítat Velikonoce</button>
        </div>

        <!-- Moon Phase Calculator -->
        <div id="moonPhaseCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🌙 Fáze Měsíce</h1>
                <p>Zjistěte fázi Měsíce pro dané datum</p>
            </div>
            <div id="moonDisplay" class="display">
                <div class="display-text">Zadejte datum pro zjištění fáze Měsíce</div>
            </div>
            <div class="input-section">
                <label class="input-label">Datum (DD.MM.RRRR):</label>
                <input type="text" id="moonDate" class="date-input" placeholder="6.7.2025" inputmode="numeric">
            </div>
            <button id="moonBtn" class="calculate-btn">Vypočítat fázi</button>
        </div>

        <!-- Date Math Calculator -->
        <div id="dateMathCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>➕ Kalendářní aritmetika</h1>
                <p>Přičítání/odčítání dnů a výpočet rozdílů mezi daty</p>
            </div>
            <div id="dateMathDisplay" class="display">
                <div class="display-text">Vyberte typ výpočtu a zadejte data</div>
            </div>
            <div class="input-section">
                <label class="input-label">Typ výpočtu:</label>
                <select id="mathType" class="date-input">
                    <option value="add">Přičíst dny k datu</option>
                    <option value="diff">Rozdíl mezi daty</option>
                </select>
            </div>
            <div id="addOperation" class="input-section">
                <div class="input-row">
                    <div class="input-col">
                        <label class="input-label">Datum:</label>
                        <input type="text" id="mathDate1" class="date-input" placeholder="1.1.2025" inputmode="numeric">
                    </div>
                    <div class="input-col">
                        <label class="input-label">Dny (+/-):</label>
                        <input type="number" id="mathDays" class="number-input" placeholder="100">
                    </div>
                </div>
            </div>
            <div id="diffOperation" class="input-section" style="display: none;">
                <div class="input-row">
                    <div class="input-col">
                        <label class="input-label">Od data:</label>
                        <input type="text" id="mathDate2" class="date-input" placeholder="1.1.2025" inputmode="numeric">
                    </div>
                    <div class="input-col">
                        <label class="input-label">Do data:</label>
                        <input type="text" id="mathDate3" class="date-input" placeholder="31.12.2025" inputmode="numeric">
                    </div>
                </div>
            </div>
            <button id="dateMathBtn" class="calculate-btn">Vypočítat</button>
        </div>

        <!-- NEW: Sun Events Calculator -->
        <div id="sunEventsCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>☀️ Sluneční události</h1>
                <p>Východ, západ slunce a délka dne pro zadané místo</p>
            </div>
            <div id="sunEventsDisplay" class="display">
                <div class="display-text">Zadejte datum a souřadnice pro výpočet slunečních událostí</div>
            </div>
            <div class="input-section">
                <label class="input-label">Datum (DD.MM.RRRR):</label>
                <input type="text" id="sunEventsDate" class="date-input" placeholder="21.6.2025" inputmode="numeric">
            </div>
            <div class="input-row">
                <div class="input-col">
                    <label class="input-label">Zeměpisná šířka:</label>
                    <input type="number" id="latitude" class="location-input" placeholder="50.0755" step="0.0001" min="-90" max="90">
                </div>
                <div class="input-col">
                    <label class="input-label">Zeměpisná délka:</label>
                    <input type="text" id="longitude" class="location-input" placeholder="14.4378" step="0.0001" min="-180" max="180"input inputmode="numeric">
                </div>
            </div>
            <div class="format-hint">Praha: 50.0755, 14.4378 • Brno: 49.1951, 16.6068</div>
            <button id="sunEventsBtn" class="calculate-btn">Vypočítat sluneční události</button>
        </div>

        <!-- NEW: Planet Positions Calculator -->
        <div id="planetPositionsCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🪐 Pozice planet</h1>
                <p>Heliocentriské a geocentrické pozice planet</p>
            </div>
            <div id="planetDisplay" class="display">
                <div class="display-text">Zadejte datum pro výpočet pozic planet</div>
            </div>
<div class="input-section">
    <label class="input-label">Datum (DD.MM.RRRR):</label>
    <input type="text" id="planetDate" class="date-input" placeholder="1.1.2025" inputmode="numeric">
</div>
<div class="input-row">
    <div class="input-col">
        <label class="input-label">Čas (HH:MM):</label>
        <input type="time" id="planetTime" class="date-input" value="00:00">
    </div>
    <div class="input-col">
        <label class="input-label">Časové pásmo:</label>
        <select id="planetTimezone" class="date-input">
            <option value="0">UTC (Greenwichský čas)</option>
            <option value="1" selected>CET (UTC+1)</option>
            <option value="2">CEST (UTC+2 - letní čas)</option>
            <option value="-5">EST (UTC-5)</option>
            <option value="-8">PST (UTC-8)</option>
        </select>
    </div>
</div>
<button id="planetBtn" class="calculate-btn">Vypočítat pozice planet</button>
</div>
        <!-- NEW: Eclipses Calculator -->
        <div id="eclipsesCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>🌑 Zatmění</h1>
                <p>Sluneční a měsíční zatmění v daném roce</p>
            </div>
            <div id="eclipsesDisplay" class="display">
                <div class="display-text">Zadejte rok pro výpočet zatmění</div>
            </div>
            <div class="input-section">
                <label class="input-label">Rok:</label>
                <input type="number" id="eclipsesYear" class="number-input" placeholder="2025" min="1900" max="2100">
            </div>
            <button id="eclipsesBtn" class="calculate-btn">Najít zatmění</button>
        </div>

        <!-- NEW: Sidereal Time Calculator -->
        <div id="siderealTimeCalculator" class="calculator-view">
            <div class="back-button" data-back="dayOfWeek">← Zpět na hlavní menu</div>
            <div class="header">
                <h1>⏰ Hvězdný čas</h1>
                <p>Výpočet hvězdného času pro dané místo a čas</p>
            </div>
            <div id="siderealDisplay" class="display">
                <div class="display-text">Zadejte datum, čas a zeměpisnou délku</div>
            </div>
            <div class="input-section">
                <label class="input-label">Datum (DD.MM.RRRR):</label>
                <input type="text" id="siderealDate" class="date-input" placeholder="1.1.2025" inputmode="numeric">
            </div>
            
            <div class="input-row">
                <div class="input-col">
                    <label class="input-label">Čas (HH:MM):</label>
                    <input type="time" id="siderealTime" class="date-input">
                </div>
                <div class="input-col">
                    <label class="input-label">Letní čas:</label>
                    <select id="siderealDST" class="date-input">
                        <option value="0">Zimní čas (standardní)</option>
                        <option value="1">Letní čas (+1 hodina)</option>
                    </select>
                </div>
            </div>
            <div class="input-section">
                <label class="input-label">Zeměpisná délka:</label>
                <input type="text" id="siderealLongitude" class="location-input" placeholder="14.4378" step="0.0001" min="-180" max="180">
                <div class="format-hint">Praha: 14.4378° • Londýn: -0.1278° • New York: -74.0060°</div>
            </div>
            
            <button id="siderealBtn" class="calculate-btn">Vypočítat hvězdný čas</button>
        </div>
    </div>

<script>
(function() {
    'use strict';
    var isMenuOpen = false;
    var currentCalculator = 'dayOfWeek';
    var hasLocalStorage = false;
    var activeInput = null;
    
    // Test localStorage availability
    try {
        if (typeof Storage !== 'undefined' && window.localStorage) {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            hasLocalStorage = true;
        }
    } catch (e) {
        hasLocalStorage = false;
    }
    
    // Theme management
    function getStoredTheme() {
        if (hasLocalStorage) {
            try {
                return localStorage.getItem('selectedTheme') || '';
            } catch (e) {
                return '';
            }
        }
        return '';
    }
    
    function setStoredTheme(theme) {
        if (hasLocalStorage) {
            try {
                localStorage.setItem('selectedTheme', theme);
            } catch (e) {}
        }
    }
    
    // Menu functionality
    function toggleMenu() {
        var dropdown = document.getElementById('menuDropdown');
        if (!dropdown) return;
        
        isMenuOpen = !isMenuOpen;
        if (isMenuOpen) {
            dropdown.classList.add('show');
            dropdown.style.display = 'block';
        } else {
            dropdown.classList.remove('show');
            setTimeout(function() {
                if (!isMenuOpen) dropdown.style.display = 'none';
            }, 300);
        }
    }
    
    function toggleSubmenu(submenuId) {
        var submenu = document.getElementById(submenuId);
        if (!submenu) return;
        
        if (submenu.classList.contains('show')) {
            submenu.classList.remove('show');
        } else {
            submenu.classList.add('show');
        }
    }

    // Calculator switching
    function showCalculator(calculatorType) {
        var calculators = document.querySelectorAll('.calculator-view');
        for (var i = 0; i < calculators.length; i++) {
            calculators[i].classList.remove('active');
        }

        var targetCalculator;
        switch(calculatorType) {
            case 'year-finder':
                targetCalculator = document.getElementById('yearFinderCalculator');
                currentCalculator = 'yearFinder';
                break;
            case 'calendar-converter':
                targetCalculator = document.getElementById('calendarConverterCalculator');
                currentCalculator = 'calendarConverter';
                break;
            case 'easter':
                targetCalculator = document.getElementById('easterCalculator');
                currentCalculator = 'easter';
                break;
            case 'moon-phase':
                targetCalculator = document.getElementById('moonPhaseCalculator');
                currentCalculator = 'moonPhase';
                break;
            case 'date-math':
                targetCalculator = document.getElementById('dateMathCalculator');
                currentCalculator = 'dateMath';
                break;
            case 'sun-events':
                targetCalculator = document.getElementById('sunEventsCalculator');
                currentCalculator = 'sunEvents';
                break;
            case 'planet-positions':
                targetCalculator = document.getElementById('planetPositionsCalculator');
                currentCalculator = 'planetPositions';
                break;
            case 'eclipses':
                targetCalculator = document.getElementById('eclipsesCalculator');
                currentCalculator = 'eclipses';
                break;
            case 'sidereal-time':
                targetCalculator = document.getElementById('siderealTimeCalculator');
                currentCalculator = 'siderealTime';
                break;
            default:
                targetCalculator = document.getElementById('dayOfWeekCalculator');
                currentCalculator = 'dayOfWeek';
        }
        if (targetCalculator) {
            targetCalculator.classList.add('active');
        }
        
        var dropdown = document.getElementById('menuDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            isMenuOpen = false;
        }
    }

    function changeTheme(themeName) {
        document.body.className = themeName;
        setStoredTheme(themeName);
        var dropdown = document.getElementById('menuDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            isMenuOpen = false;
        }
    }
    
    // Display management
    function getCurrentDisplay() {
        switch(currentCalculator) {
            case 'yearFinder': return document.getElementById('yearFinderDisplay');
            case 'calendarConverter': return document.getElementById('converterDisplay');
            case 'easter': return document.getElementById('easterDisplay');
            case 'moonPhase': return document.getElementById('moonDisplay');
            case 'dateMath': return document.getElementById('dateMathDisplay');
            case 'sunEvents': return document.getElementById('sunEventsDisplay');
            case 'planetPositions': return document.getElementById('planetDisplay');
            case 'eclipses': return document.getElementById('eclipsesDisplay');
            case 'siderealTime': return document.getElementById('siderealDisplay');
            default: return document.getElementById('display');
        }
    }
    
    function showLoading() {
        var display = getCurrentDisplay();
        if (display) {
            display.className = 'display';
            display.innerHTML = '<div class="display-text"><span class="loading"></span>Počítám...</div>';
        }
    }
    
    function showResult(result) {
        var display = getCurrentDisplay();
        if (display) {
            display.className = 'display result';
            display.innerHTML = '<div class="display-text">' + result + '</div>';
        }
    }
    
    function showError(error) {
        var display = getCurrentDisplay();
        if (display) {
            display.className = 'display error';
            display.innerHTML = '<div class="display-text">⚠️ ' + error + '</div>';
        }
    }
    
    function clearDisplay() {
        var display = getCurrentDisplay();
        if (display) {
            display.className = 'display';
            var defaultText = currentCalculator === 'dayOfWeek' ? 
                'Zadejte datum pro výpočet' : 
                'Zadejte parametry pro výpočet';
            display.innerHTML = '<div class="display-text">' + defaultText + '</div>';
        }
    }

    function showVersion() {
        var display = getCurrentDisplay();
        if (display) {
            display.className = 'display result';
            display.innerHTML = '<div class="display-text">📅 <strong>Kalendářní kalkulátor v4.0</strong><br><small>Nové astronomické funkce: Sluneční události • Pozice planet<br>Zatmění • Hvězdný čas • Vylepšené měsíční fáze</small></div>';
        }
        var dropdown = document.getElementById('menuDropdown');
        if (dropdown) {
            dropdown.classList.remove('show');
            dropdown.style.display = 'none';
            isMenuOpen = false;
        }
    }

    function fillDate(dateString) {
        var dateInput = document.getElementById('dateInput');
        if (dateInput) {
            dateInput.value = dateString;
            clearDisplay();
        }
    }
    
    // Date parsing and validation functions
    function parseDate(dateString) {
        try {
            var cleaned = dateString.trim();
            var parts = cleaned.split(/[.\-\/\s]+/);
            
            if (parts.length === 1 && /^\d+$/.test(cleaned)) {
                var num = cleaned;
                if (num.length === 8) {
                    parts = [num.substring(0, 2), num.substring(2, 4), num.substring(4, 8)];
                } else if (num.length === 6) {
                    var year = parseInt(num.substring(4, 6));
                    var fullYear = year >= 50 ? 1900 + year : 2000 + year;
                    parts = [num.substring(0, 2), num.substring(2, 4), fullYear.toString()];
                } else if (num.length === 7) {
                    if (parseInt(num.substring(1, 3)) <= 12) {
                        parts = [num.substring(0, 1), num.substring(1, 3), num.substring(3, 7)];
                    } else {
                        parts = [num.substring(0, 2), num.substring(2, 3), num.substring(3, 7)];
                    }
                } else if (num.length === 5) {
                    if (parseInt(num.substring(1, 3)) <= 12) {
                        var year = parseInt(num.substring(3, 5));
                        var fullYear = year >= 50 ? 1900 + year : 2000 + year;
                        parts = [num.substring(0, 1), num.substring(1, 3), fullYear.toString()];
                    } else {
                        var year = parseInt(num.substring(3, 5));
                        var fullYear = year >= 50 ? 1900 + year : 2000 + year;
                        parts = [num.substring(0, 2), num.substring(2, 3), fullYear.toString()];
                    }
                } else if (num.length === 4) {
                    return { day: 1, month: 1, year: parseInt(num) };
                }
            }
            
            if (parts.length !== 3) return null;

            var day = parseInt(parts[0]);
            var month = parseInt(parts[1]);
            var year = parseInt(parts[2]);

            if (year < 100 && parts[2].length === 2 && (cleaned.indexOf('.') !== -1 || cleaned.indexOf('/') !== -1 || cleaned.indexOf('-') !== -1 || cleaned.indexOf(' ') !== -1)) {
                if (year >= 50) {
                    year += 1900;
                } else {
                    year += 2000;
                }
            }

            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            return { day: day, month: month, year: year };
        } catch (e) {
            return null;
        }
    }
    
    function validateDate(day, month, year) {
        if (day < 1 || day > 31) return "Den musí být mezi 1 a 31";
        if (month < 1 || month > 12) return "Měsíc musí být mezi 1 a 12";
        if (year < 1) return "Rok musí být alespoň 1 (začátek našeho letopočtu)";

        var daysInMonth = [31, isLeapYear(year) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        if (day > daysInMonth[month - 1]) {
            return month + ". měsíc má pouze " + daysInMonth[month - 1] + " dní";
        }
        return null;
    }
    
    function isLeapYear(year) {
        if (year < 1582) {
            return year % 4 === 0;
        } else {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }
    }
    
    function openLink(url) {
        try {
            if (window.open) {
                window.open(url, '_blank');
            } else {
                window.location.href = url;
            }
        } catch (error) {
            try {
                window.location.href = url;
            } catch (e) {}
        }
        toggleMenu();
    }

    // Day of week calculation (Zeller's congruence)
    function getDayOfWeek(d, m, r) {
        try {
            if (r === 1582 && m === 10 && d >= 5 && d <= 14) {
                return '<strong>' + d + '.' + m + '.' + r + '</strong> = Datum neexistuje!<br><small>Při přechodu z juliánského na gregoriánský kalendář byly tyto dny přeskočeny</small>';
            }

            var cal, h;

            if (r < 1582 || (r === 1582 && m < 10) || (r === 1582 && m === 10 && d <= 4)) {
                cal = "🗓 juliánský ";
                var me, rr;
                if (m < 3) {
                    me = m + 12;
                    rr = r - 1;
                } else {
                    me = m;
                    rr = r;
                }
                h = ((d + Math.floor((13 * (me + 1)) / 5) + rr + Math.floor(rr / 4) - 1) % 7 + 7) % 7;
                var daysJulian = ["Pátek", "Sobota", "Neděle", "Pondělí", "Úterý", "Středa", "Čtvrtek"];
                return '🗓️ <strong>' + d + '.' + m + '.' + r + '</strong> = <strong>' + daysJulian[h] + '</strong><br><small>' + cal + (isLeapYear(r) ? ' • přestupný' : '') + '</small>';
            } else {
                cal = "🗓 gregoriánský ";
                var me, rr;
                if (m < 3) {
                    me = m + 12;
                    rr = r - 1;
                } else {
                    me = m;
                    rr = r;
                }
                var k = rr % 100;
                var j = Math.floor(rr / 100);
                h = ((d + Math.floor((13 * (me + 1)) / 5) + k + Math.floor(k / 4) + Math.floor(j / 4) - (2 * j)) % 7 + 7) % 7;
                var daysGregorian = ["Sobota", "Neděle", "Pondělí", "Úterý", "Středa", "Čtvrtek", "Pátek"];
                return '🗓️ <strong>' + d + '.' + m + '.' + r + '</strong> = <strong>' + daysGregorian[h] + '</strong><br><small>' + cal + (isLeapYear(r) ? ' • přestupný' : '') + '</small>';
            }
        } catch (e) {
            return "❌ Chyba ve výpočtu";
        }
    }
    
    function getDayOfWeekSimple(d, m, r) {
        var me = m, rr = r;
        if (m < 3) {
            me = m + 12;
            rr = r - 1;
        }
        
        if (r < 1582 || (r === 1582 && m < 10) || (r === 1582 && m === 10 && d <= 4)) {
            var h = ((d + Math.floor((13 * (me + 1)) / 5) + rr + Math.floor(rr / 4) - 1) % 7 + 7) % 7;
            var daysJulian = ["pátek", "sobota", "neděle", "pondělí", "úterý", "středa", "čtvrtek"];
            return daysJulian[h];
        } else {
            var k = rr % 100;
            var j = Math.floor(rr / 100);
            var h = ((d + Math.floor((13 * (me + 1)) / 5) + k + Math.floor(k / 4) + Math.floor(j / 4) - (2 * j)) % 7 + 7) % 7;
            var daysGregorian = ["sobota", "neděle", "pondělí", "úterý", "středa", "čtvrtek", "pátek"];
            return daysGregorian[h];
        }
    }
    
    // Julian day number calculations
    function getJulianDayNumber(day, month, year, isJulian) {
        if (isJulian === undefined) isJulian = false;
        
        var a = Math.floor((14 - month) / 12);
        var y = year + 4800 - a;
        var m = month + 12 * a - 3;
        
        var jdn = day + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4);
        
        if (!isJulian) {
            jdn = jdn - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
        } else {
            jdn = jdn - 32083;
        }
        
        return jdn;
    }
    
    function getDateFromJulianDay(jdn, isJulian) {
        if (isJulian === undefined) isJulian = false;
        
        var a, b, c, d, e;
        
        if (!isJulian) {
            a = jdn + 32044;
            b = Math.floor((4 * a + 3) / 146097);
            c = a - Math.floor((146097 * b) / 4);
            d = Math.floor((4 * c + 3) / 1461);
            e = c - Math.floor((1461 * d) / 4);
        } else {
            a = jdn + 32082;
            d = Math.floor((4 * a + 3) / 1461);
            e = a - Math.floor((1461 * d) / 4);
        }
        
        var m = Math.floor((5 * e + 2) / 153);
        var day = e - Math.floor((153 * m + 2) / 5) + 1;
        var month = m + 3 - 12 * Math.floor(m / 10);
        var year = (!isJulian ? 100 * b : 0) + d - 4800 + Math.floor(m / 10);
        
        return { day: day, month: month, year: year };
    }
    
    // Date arithmetic
    function addDays(date, days) {
        var newDate = new Date(date.year, date.month - 1, date.day);
        newDate.setDate(newDate.getDate() + days);
        return {
            day: newDate.getDate(),
            month: newDate.getMonth() + 1,
            year: newDate.getFullYear()
        };
    }
    
    function formatDate(date) {
        return date.day + '.' + date.month + '.' + date.year;
    }
    
    // Easter calculation
    function getEasterDate(year) {
        var a = year % 19;
        var b = Math.floor(year / 100);
        var c = year % 100;
        var d = Math.floor(b / 4);
        var e = b % 4;
        var f = Math.floor((b + 8) / 25);
        var g = Math.floor((b - f + 1) / 3);
        var h = (19 * a + b - d - g + 15) % 30;
        var i = Math.floor(c / 4);
        var k = c % 4;
        var l = (32 + 2 * e + 2 * i - h - k) % 7;
        var m = Math.floor((a + 11 * h + 22 * l) / 451);
        var month = Math.floor((h + l - 7 * m + 114) / 31);
        var day = ((h + l - 7 * m + 114) % 31) + 1;
        
        return { day: day, month: month, year: year };
    }
    
    // Enhanced Moon phase calculations
    function getMoonAge(day, month, year) {
        var jd = getJulianDayNumber(day, month, year);
        var newMoonJD = 2451549.5; // JD nového měsíce 6.1.2000
        var synodicMonth = 29.53058867; // synodický měsíc ve dnech
        
        var daysSinceNewMoon = (jd - newMoonJD) % synodicMonth;
        if (daysSinceNewMoon < 0) daysSinceNewMoon += synodicMonth;
        
        return daysSinceNewMoon;
    }
    
    function getMoonPhase(age) {
        if (age < 1.84566) return "Nov";
        else if (age < 5.53699) return "Dorůstající srpek";
        else if (age < 9.22831) return "První čtvrť";
        else if (age < 12.91963) return "Dorůstající měsíc";
        else if (age < 16.61096) return "Úplněk";
        else if (age < 20.30228) return "Ubývající měsíc";
        else if (age < 23.99361) return "Poslední čtvrť";
        else if (age < 27.68493) return "Ubývající srpek";
        else return "Nov";
    }
    
    function getMoonEmoji(age) {
        if (age < 1.84566) return "🌑";
        else if (age < 5.53699) return "🌒";
        else if (age < 9.22831) return "🌓";
        else if (age < 12.91963) return "🌔";
        else if (age < 16.61096) return "🌕";
        else if (age < 20.30228) return "🌖";
        else if (age < 23.99361) return "🌗";
        else if (age < 27.68493) return "🌘";
        else return "🌑";
    }


// NEW: Corrected sun events calculations using NOAA algorithm
function calculateSunEvents(day, month, year, latitude, longitude) {
    try {
        var jd = getJulianDayNumber(day, month, year);
        var T = (jd - 2451545.0) / 36525.0; // Centuries since J2000
        
        // Check for polar regions
        if (Math.abs(latitude) > 66.5) {
            return handlePolarRegions(day, month, year, latitude, longitude);
        }
        
        // Solar mean longitude (degrees)
        var L0 = (280.46646 + T * (36000.76983 + T * 0.0003032)) % 360;
        if (L0 < 0) L0 += 360;
        
        // Solar mean anomaly (degrees)  
        var M = (357.52911 + T * (35999.05029 - T * 0.0001537)) % 360;
        var M_rad = M * Math.PI / 180;
        
        // Earth's eccentricity
        var e = 0.016708634 - T * (0.000042037 + T * 0.0000001267);
        
        // Sun's equation of center (degrees)
        var C = Math.sin(M_rad) * (1.914602 - T * (0.004817 + T * 0.000014)) +
                Math.sin(2 * M_rad) * (0.019993 - T * 0.000101) +
                Math.sin(3 * M_rad) * 0.000289;
        
        // True longitude (degrees)
        var trueLon = L0 + C;
        
        // Apparent longitude - nutation correction (degrees)
        var omega = (125.04 - 1934.136 * T) * Math.PI / 180;
        var apparentLon = trueLon - 0.00569 - 0.00478 * Math.sin(omega);
        
        // Obliquity of ecliptic (degrees)
        var epsilon0 = 23 + (26 + (21.448 - T * (46.815 + T * (0.00059 - T * 0.001813))) / 60) / 60;
        var epsilon = epsilon0 + 0.00256 * Math.cos(omega);
        var epsilon_rad = epsilon * Math.PI / 180;
        var apparentLon_rad = apparentLon * Math.PI / 180;
        
        // Solar declination (radians)
        var declination = Math.asin(Math.sin(epsilon_rad) * Math.sin(apparentLon_rad));
        
        // Equation of time (minutes)
        var y = Math.pow(Math.tan(epsilon_rad / 2), 2);
        var L0_rad = L0 * Math.PI / 180;
        var eqTime = 4 * (180 / Math.PI) * (
            y * Math.sin(2 * L0_rad) - 
            2 * e * Math.sin(M_rad) +
            4 * e * y * Math.sin(M_rad) * Math.cos(2 * L0_rad) -
            0.5 * y * y * Math.sin(4 * L0_rad) -
            1.25 * e * e * Math.sin(2 * M_rad)
        );
        
        // Hour angle for sunrise/sunset (including atmospheric refraction)
        var latRad = latitude * Math.PI / 180;
        var zenith = 90.833; // 90° + 50' atmospheric refraction + 16' solar radius
        var cosHA = (Math.cos(zenith * Math.PI / 180) - Math.sin(latRad) * Math.sin(declination)) / 
                   (Math.cos(latRad) * Math.cos(declination));
        
        // Check for polar day/night
        if (cosHA > 1) {
            return {
                sunrise: "Slunce nevychází",
                sunset: "Slunce nevychází", 
                dayLength: "0:00",
                declination: (declination * 180 / Math.PI).toFixed(2) + '°',
                polarNight: true
            };
        }
        if (cosHA < -1) {
            return {
                sunrise: "Slunce nezapadá",
                sunset: "Slunce nezapadá",
                dayLength: "24:00", 
                declination: (declination * 180 / Math.PI).toFixed(2) + '°',
                polarDay: true
            };
        }
        
        var HA = Math.acos(cosHA) * 180 / Math.PI; // Hour angle in degrees
        
        // Determine timezone (with DST consideration)
        var timezone = determineTimezone(longitude, month);
        
        // Calculate sunrise and sunset times (local solar time)
        var solarNoon = 12 - eqTime / 60 + longitude / 15 - timezone ;
        // Apply timezone offset differently
var timezoneOffset = timezone;
        var sunrise = solarNoon - HA / 15;
        var sunset = solarNoon + HA / 15;
        // Apply timezone correction here instead
sunrise += timezoneOffset;
sunset += timezoneOffset;

        // Ensure times are in 0-24 range
        while (sunrise < 0) sunrise += 24;
        while (sunrise >= 24) sunrise -= 24;
        while (sunset < 0) sunset += 24;
        while (sunset >= 24) sunset -= 24;
        
        // Calculate day length
        var dayLengthHours = HA * 2 / 15; // Hours of daylight
        var dayLengthHour = Math.floor(dayLengthHours);
        var dayLengthMin = Math.round((dayLengthHours - dayLengthHour) * 60);
        
        return {
            sunrise:
            formatTime(sunrise),
            sunset: formatTime(sunset),
            dayLength: formatHoursMinutes(dayLengthHour, dayLengthMin),
            declination: (declination * 180 / Math.PI).toFixed(2) + '°',
            eqTime: eqTime.toFixed(1) + ' min',
            timezone: 'UTC' + (timezone >= 0 ? '+' : '') + timezone
        };
        
    } catch (error) {
        return {
            sunrise: "Chyba výpočtu",
            sunset: "Chyba výpočtu", 
            dayLength: "---",
            declination: "---"
        };
    }
}

function determineTimezone(longitude, month) {
    // Basic timezone from longitude
    var basicTZ = Math.round(longitude / 15);
    
    // Determine if DST applies (simplified for European rules)
    var isDST = (month > 3 && month < 10) || 
                (month === 3 && month >= 3) ||  // Rough DST start
                (month === 10 && month <= 10);  // Rough DST end
    
    // Common timezone adjustments
    if (longitude >= -7.5 && longitude <= 22.5) { // Central Europe
        return isDST ? 2 : 1 ; // CET/CEST
    }
    
    return basicTZ + (isDST ? 1 : 0);
}

function handlePolarRegions(day, month, year, latitude, longitude) {
    // Simplified polar region handling
    var jd = getJulianDayNumber(day, month, year);
    var T = (jd - 2451545.0) / 36525.0;
    var L0 = (280.46646 + T * (36000.76983 + T * 0.0003032)) % 360;
    var M = (357.52911 + T * (35999.05029 - T * 0.0001537)) % 360;
    var C = Math.sin(M * Math.PI / 180) * 1.914602;
    var trueLon = L0 + C;
    var epsilon = 23.4393 - 0.0130 * T;
    var declination = Math.asin(Math.sin(epsilon * Math.PI / 180) * Math.sin(trueLon * Math.PI / 180));
    
    // Determine if it's polar day or night
    var isPolarDay = (latitude > 0 && declination > (90 - latitude) * Math.PI / 180) ||
                     (latitude < 0 && declination < (90 + latitude) * Math.PI / 180);
    var isPolarNight = (latitude > 0 && declination < -(90 - latitude) * Math.PI / 180) ||
                       (latitude < 0 && declination > -(90 + latitude) * Math.PI / 180);
    
    if (isPolarDay) {
        return {
            sunrise: "Slunce nezapadá",
            sunset: "Slunce nezapadá", 
            dayLength: "24:00",
            declination: (declination * 180 / Math.PI).toFixed(2) + '°',
            polarDay: true
        };
    } else if (isPolarNight) {
        return {
            sunrise: "Slunce nevychází",
            sunset: "Slunce nevychází",
            dayLength: "0:00", 
            declination: (declination * 180 / Math.PI).toFixed(2) + '°',
            polarNight: true
        };
    } else {
        // Use standard calculation for border cases
        return calculateSunEvents(day, month, year, latitude, longitude);
    }
}

function formatTime(hours) {
    var h = Math.floor(hours);
    var mFloat = (hours - h) * 60;
    var m = Math.floor(mFloat);
    var s = Math.round((mFloat - m) * 60);

    // Korekce přetečení sekund
    if (s === 60) {
        s = 0;
        m++;
    }
    if (m === 60) {
        m = 0;
        h++;
    }
    if (h >= 24) h -= 24;
    if (h < 0) h += 24;

    return (h < 10 ? '0' : '') + h + ':' +
           (m < 10 ? '0' : '') + m + ':' +
           (s < 10 ? '0' : '') + s;
}

function formatHoursMinutes(hours, minutes) {
    if (minutes >= 60) { hours++; minutes -= 60; }
    return (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
}
    
    // NEW: Simplified planet positions
  // NEW: Geocentric planet positions as seen from Earth
function getPlanetPositions(day, month, year, hour, minute, timezone) {
    // Default values if time not provided
    if (hour === undefined) hour = 0;
    if (minute === undefined) minute = 0;
    if (timezone === undefined) timezone = 0;
    
    // Convert to Julian Day with time
    var jd = getJulianDayNumber(day, month, year);
    
    // Add time component (convert local time to UTC)
    var timeOffset = (hour - timezone + minute / 60.0) / 24.0;
    jd += timeOffset;
    
    var T = (jd - 2451545.0) / 36525;
 // Centuries since J2000
    
    // Calculate Earth's position first
    var earthLongitude = getEarthPosition(T);
    
    var planets = [];
    
    // Inner planets (Mercury, Venus)
    var mercury = calculateInnerPlanet("Merkur", T, 252.25, 149472.67, 0.387, 0.206, earthLongitude);
    planets.push(mercury);
    
    var venus = calculateInnerPlanet("Venuše", T, 181.98, 58517.82, 0.723, 0.007, earthLongitude);
    planets.push(venus);
    
    // Outer planets (Mars, Jupiter, Saturn)
    var mars = calculateOuterPlanet("Mars", T, 355.43, 19140.30, 1.524, 0.093, earthLongitude);
    planets.push(mars);
    
    var jupiter = calculateOuterPlanet("Jupiter", T, 34.35, 3034.74, 5.203, 0.048, earthLongitude);
    planets.push(jupiter);
    
    var saturn = calculateOuterPlanet("Saturn", T, 50.08, 1222.11, 9.537, 0.054, earthLongitude);
    planets.push(saturn);
    
    return planets;
}

function getEarthPosition(T) {
    // Earth's mean longitude
    var L = (100.464 + 35999.372 * T) % 360;
    if (L < 0) L += 360;
    
    // Earth's mean anomaly
    var M = (357.528 + 35999.050 * T) % 360;
    var M_rad = M * Math.PI / 180;
    
    // Equation of center
    var C = 1.915 * Math.sin(M_rad) + 0.020 * Math.sin(2 * M_rad);
    
    // True longitude
    var trueLongitude = (L + C) % 360;
    if (trueLongitude < 0) trueLongitude += 360;
    
    return trueLongitude;
}

function calculateInnerPlanet(name, T, L0, n, a, e, earthLong) {
    // More accurate planetary calculations
    var planetConstants = getPlanetConstants(name);
    
    // Mean longitude with higher precision
    var L = (planetConstants.L0 + planetConstants.n * T + planetConstants.n2 * T * T) % 360;
    if (L < 0) L += 360;
    
    // Mean anomaly
    var M = (planetConstants.M0 + planetConstants.M1 * T) % 360;
    var M_rad = M * Math.PI / 180;
    
    // Equation of center (simplified)
    var C = planetConstants.e * Math.sin(M_rad) * (180 / Math.PI);
    
    // True longitude
    var trueLong = (L + C) % 360;
    if (trueLong < 0) trueLong += 360;
    
    // Calculate elongation from Sun (as seen from Earth)
    var elongation = Math.abs(trueLong - earthLong);
    if (elongation > 180) elongation = 360 - elongation;
    
    // More accurate geocentric position
    var geocentricLong = calculateGeocentricPosition(trueLong, earthLong, a, true);
    
    var visibility = getAdvancedVisibility(name, elongation, trueLong, earthLong);
    var constellation = getConstellation(geocentricLong);
    var magnitude = calculateMagnitude(name, elongation, a);
    
    return {
        name: name,
        position: geocentricLong.toFixed(1) + "° (geocentrická délka)",
        elongation: elongation.toFixed(1) + "° od Slunce",
        visibility: visibility,
        constellation: constellation,
        magnitude: magnitude,
        type: "Vnitřní planeta"
    };
}

function getPlanetConstants(name) {
    var constants = {
        "Merkur": {
            L0: 252.25084, n: 149472.67486, n2: -0.00000536,
            M0: 174.79252, M1: 149472.51529, e: 0.20563175
        },
        "Venuše": {
            L0: 181.97973, n: 58517.81539, n2: 0.00000165,
            M0: 50.44675, M1: 58517.81538, e: 0.00677192
        }
    };
    return constants[name] || constants["Merkur"];
}

function getOuterPlanetConstants(name) {
    var constants = {
        "Mars": {
            L0: 355.43299, n: 19140.29934, n2: 0.00000261,
            M0: 319.51913, M1: 19139.85475, e: 0.09341233
        },
        "Jupiter": {
            L0: 34.35148, n: 3034.74612, n2: -0.00008501,
            M0: 225.32833, M1: 3034.69202, e: 0.04849485
        },
        "Saturn": {
            L0: 50.07571, n: 1222.11494, n2: 0.00025899,
            M0: 175.46622, M1: 1221.55147, e: 0.05554814
        }
    };
    return constants[name] || constants["Mars"];
}

function calculateGeocentricPosition(planetLong, earthLong, planetDist, isInner) {
    // Simplified geometric calculation
    if (isInner) {
        // For inner planets, account for viewing angle from Earth
        var phase = (planetLong - earthLong + 360) % 360;
        return phase;
    } else {
        // For outer planets, direct geocentric longitude
        return planetLong;
    }
}

function getAdvancedVisibility(name, elongation, planetLong, earthLong) {
    if (name === "Merkur" || name === "Venuše") {
        if (elongation < 10) return "Neviditelná (příliš blízko Slunce)";
        if (elongation > 15 && elongation < 30) {
            var phase = (planetLong - earthLong + 360) % 360;
            if (phase > 180) return "Ranní viditelnost (východní elongace)";
            else return "Večerní viditelnost (západní elongace)";
        }
        if (elongation >= 30) return "Maximální viditelnost";
        return "Špatně viditelná";
    } else {
        // Outer planets
        if (elongation < 30) return "V opozici (ideální pozorovací podmínky)";
        if (elongation < 90) return "Dobře viditelná celou noc";
        if (elongation < 150) return "Viditelná večer/ráno";
        return "Blízko Slunce (neviditelná)";
    }
}

function calculateMagnitude(name, elongation, distance) {
    // More accurate magnitude calculation
    var baseMag = {
        "Merkur": -0.4, 
        "Venuše": -4.0, 
        "Mars": -2.0, 
        "Jupiter": -2.5, 
        "Saturn": 0.0
    };
    
    var mag = baseMag[name];
    if (mag === undefined) mag = 5.0; // fallback for unknown planets
    
    // Adjust for distance and phase (simplified)
    if (distance && !isNaN(distance)) {
        mag += Math.log10(distance) * 2.5; // distance modulus approximation
    }
    
    // Phase effect (opposition effect for outer planets)
    if (elongation < 30) {
        mag -= 0.3; // Opposition surge
    } else if (elongation > 150) {
        mag += 0.5; // Worse visibility when close to Sun
    }
    
    return mag.toFixed(1) + " mag";
}

function calculateOuterPlanet(name, T, L0, n, a, e, earthLong) {
    // More accurate planetary calculations
    var planetConstants = getOuterPlanetConstants(name);
    
    // Mean longitude with higher precision
    var L = (planetConstants.L0 + planetConstants.n * T + planetConstants.n2 * T * T) % 360;
    if (L < 0) L += 360;
    
    // Mean anomaly
    var M = (planetConstants.M0 + planetConstants.M1 * T) % 360;
    var M_rad = M * Math.PI / 180;
    
    // Equation of center (simplified)
    var C = planetConstants.e * Math.sin(M_rad) * (180 / Math.PI);
    
    // True longitude
    var trueLong = (L + C) % 360;
    if (trueLong < 0) trueLong += 360;
    
    // Calculate elongation from Sun (as seen from Earth)
    var elongation = Math.abs(trueLong - earthLong);
    if (elongation > 180) elongation = 360 - elongation;
    
    // Geocentric position (for outer planets, approximately same as heliocentric)
    var geocentricLong = trueLong;
    
    var visibility = getAdvancedVisibility(name, elongation, trueLong, earthLong);
    var constellation = getConstellation(geocentricLong);
    var magnitude = calculateMagnitude(name, elongation, a);
    
    return {
        name: name,
        position: geocentricLong.toFixed(1) + "° (geocentrická délka)",
        elongation: elongation.toFixed(1) + "° od Slunce",
        visibility: visibility,
        constellation: constellation,
        magnitude: magnitude,
        type: "Vnější planeta"
    };
}

function getVisibilityInfo(longitude, isInner, phaseAngle) {
    if (isInner) {
        // Inner planets visibility based on elongation from Sun
        if (longitude > 45 && longitude < 135) return "Ranní viditelnost (východ před Sluncem)";
        if (longitude > 225 && longitude < 315) return "Večerní viditelnost (západ po Slunci)";
        if (longitude <= 45 || longitude >= 315) return "Blízko Slunce (neviditelná)";
        return "Za Sluncem (neviditelná)";
    } else {
        // Outer planets visibility
        if (phaseAngle < 30) return "V opozici (celou noc viditelná)";
        if (phaseAngle < 90) return "Dobře viditelná večer/noc";
        if (phaseAngle < 150) return "Viditelná část noci";
        return "Blízko Slunce (špatně viditelná)";
    }
}

function getConstellation(longitude) {
    // Simplified constellation mapping based on ecliptic longitude
    var constellations = [
        {start: 0, end: 30, name: "Beran"},
        {start: 30, end: 60, name: "Býk"}, 
        {start: 60, end: 90, name: "Blíženci"},
        {start: 90, end: 120, name: "Rak"},
        {start: 120, end: 150, name: "Lev"},
        {start: 150, end: 180, name: "Panna"},
        {start: 180, end: 210, name: "Váhy"},
        {start: 210, end: 240, name: "Štír"},
        {start: 240, end: 270, name: "Střelec"},
        {start: 270, end: 300, name: "Kozoroh"},
        {start: 300, end: 330, name: "Vodnář"},
        {start: 330, end: 360, name: "Ryby"}
    ];
    
    for (var i = 0; i < constellations.length; i++) {
        if (longitude >= constellations[i].start && longitude < constellations[i].end) {
            return constellations[i].name;
        }
    }
    return "Ryby"; // fallback
}
    
// NEW: Corrected eclipse calculations using real astronomical data
function getEclipses(year) {
    var eclipses = [];
    
    // Database of real eclipse data for accurate years (2020-2030)
    var knownEclipses = {
        2020: [
            {type: "Měsíční", date: "10.1.2020", visibility: "Viditelné z Evropy, Afriky, Asie"},
            {type: "Sluneční", date: "21.6.2020", visibility: "Prstencové - Afrika, Asie"},
            {type: "Měsíční", date: "5.7.2020", visibility: "Penumbrální - Amerika, jihozápadní Evropa"},
            {type: "Sluneční", date: "14.12.2020", visibility: "Úplné - Chile, Argentina"}
        ],
        2021: [
            {type: "Sluneční", date: "10.6.2021", visibility: "Prstencové - severní oblasti"},
            {type: "Měsíční", date: "26.5.2021", visibility: "Úplné - Pacifik, Amerika, Asie"},
            {type: "Měsíční", date: "19.11.2021", visibility: "Částečné - Amerika, severovýchodní Asie"},
            {type: "Sluneční", date: "4.12.2021", visibility: "Úplné - Antarktida"}
        ],
        2022: [
            {type: "Sluneční", date: "30.4.2022", visibility: "Částečné - jihovýchodní Pacifik"},
            {type: "Měsíční", date: "16.5.2022", visibility: "Úplné - Amerika, Evropa, Afrika"},
            {type: "Sluneční", date: "25.10.2022", visibility: "Částečné - Evropa, severovýchodní Afrika, Asie"},
            {type: "Měsíční", date: "8.11.2022", visibility: "Úplné - Asie, Austrálie, Pacifik, Amerika"}
        ],
        2023: [
            {type: "Sluneční", date: "20.4.2023", visibility: "Hybridní - jihovýchodní Asie, Austrálie"},
            {type: "Měsíční", date: "5.5.2023", visibility: "Penumbrální - Afrika, Asie, Austrálie"},
            {type: "Sluneční", date: "14.10.2023", visibility: "Prstencové - Amerika"},
            {type: "Měsíční", date: "28.10.2023", visibility: "Částečné - Evropa, Asie, Austrálie, Afrika"}
        ],
        2024: [
            {type: "Měsíční", date: "25.3.2024", visibility: "Penumbrální - Amerika"},
            {type: "Sluneční", date: "8.4.2024", visibility: "Úplné - Severní Amerika"},
            {type: "Měsíční", date: "18.9.2024", visibility: "Částečné - Amerika, Evropa, Afrika"},
            {type: "Sluneční", date: "2.10.2024", visibility: "Prstencové - Pacifik, jižní Amerika"}
        ],
        2025: [
            {type: "Měsíční", date: "14.3.2025", visibility: "Úplné - Amerika, západní Evropa"},
            {type: "Sluneční", date: "29.3.2025", visibility: "Částečné - Evropa, severozápadní Afrika, Arktida"},
            {type: "Měsíční", date: "7.9.2025", visibility: "Úplné - Evropa, Afrika, Asie, Austrálie"},
            {type: "Sluneční", date: "21.9.2025", visibility: "Částečné - Pacifik, Antarktida"}
        ],
        2026: [
            {type: "Sluneční", date: "17.2.2026", visibility: "Prstencové - Antarktida, jižní oblasti"},
            {type: "Měsíční", date: "3.3.2026", visibility: "Úplné - východní Asie, Austrálie, Pacifik, Amerika"},
            {type: "Sluneční", date: "12.8.2026", visibility: "Úplné - Grónsko, Island, Španělsko, Rusko"},
            {type: "Měsíční", date: "28.8.2026", visibility: "Částečné - východní Pacifik, Amerika, západní Afrika"}
        ],
        2027: [
            {type: "Sluneční", date: "6.2.2027", visibility: "Prstencové - jižní Pacifik, Chile, Argentina"},
            {type: "Měsíční", date: "21.2.2027", visibility: "Penumbrální - Amerika, Evropa, Afrika, Asie"},
            {type: "Sluneční", date: "2.8.2027", visibility: "Úplné - Atlantik, Španělsko, Afrika, Asie"},
            {type: "Měsíční", date: "17.8.2027", visibility: "Penumbrální - Asie, Austrálie, Pacifik"}
        ],
        2028: [
            {type: "Sluneční", date: "26.1.2028", visibility: "Prstencové - Ekvádor, Brazílie, Španělsko, Portugalsko"},
            {type: "Měsíční", date: "12.7.2028", visibility: "Částečné - Evropa, Afrika, západní Asie"},
            {type: "Sluneční", date: "22.7.2028", visibility: "Úplné - Indický oceán, Austrálie, Nový Zéland"},
            {type: "Měsíční", date: "6.1.2029", visibility: "Úplné - východní Pacifik, Amerika, západní Evropa"}
        ],
        2029: [
            {type: "Měsíční", date: "6.1.2029", visibility: "Úplné - Amerika, Evropa"},
            {type: "Sluneční", date: "14.6.2029", visibility: "Částečné - Arktida"},
            {type: "Měsíční", date: "31.12.2029", visibility: "Úplné - Evropa, Afrika, Asie, Austrálie"}
        ],
        2030: [
            {type: "Sluneční", date: "1.6.2030", visibility: "Prstencové - Alžírsko, Tunisko, Řecko, Turecko, Rusko"},
            {type: "Měsíční", date: "15.6.2030", visibility: "Částečné - Evropa, Afrika, Asie, Austrálie"},
            {type: "Sluneční", date: "25.11.2030", visibility: "Částečné - jižní Afrika, Antarktida"},
            {type: "Měsíční", date: "9.12.2030", visibility: "Penumbrální - Evropa, Asie, Austrálie, Pacifik"}
        ]
    };
    
    // If we have exact data, use it
    if (knownEclipses[year]) {
        return knownEclipses[year];
    }
    
    // For other years, use simplified Saros cycle approximation
    return calculateEclipsesUsingSaros(year);
}

function calculateEclipsesUsingSaros(year) {
    var eclipses = [];
    
    // Reference eclipses from known Saros series
    var sarosReferences = [
        // Saros 136 - major solar eclipse series
        {type: "Sluneční", referenceYear: 2017, referenceMonth: 8, referenceDay: 21, 
         sarosNumber: 136, nextYears: [2035, 2053, 2071]},
        
        // Saros 142 - active solar series  
        {type: "Sluneční", referenceYear: 2023, referenceMonth: 4, referenceDay: 20,
         sarosNumber: 142, nextYears: [2041, 2059, 2077]},
         
        // Saros 131 - lunar eclipse series
        {type: "Měsíční", referenceYear: 2018, referenceMonth: 1, referenceDay: 31,
         sarosNumber: 131, nextYears: [2036, 2054, 2072]},
         
        // Saros 134 - lunar eclipse series  
        {type: "Měsíční", referenceYear: 2021, referenceMonth: 5, referenceDay: 26,
         sarosNumber: 134, nextYears: [2039, 2057, 2075]}
    ];
    
    var sarosPeriod = 18.031; // Saros cycle in years (more precise than 18)
    var currentYear = new Date().getFullYear();
    
    for (var i = 0; i < sarosReferences.length; i++) {
        var ref = sarosReferences[i];
        var yearsSinceReference = year - ref.referenceYear;
        
        // Check if this year should have an eclipse from this Saros series
        var cyclesFromReference = yearsSinceReference / sarosPeriod;
        var isCloseToSarosCycle = Math.abs(cyclesFromReference - Math.round(cyclesFromReference)) < 0.1;
        
        if (isCloseToSarosCycle && Math.abs(yearsSinceReference) <= 200) {
            // Calculate approximate date using Saros shift
            var monthShift = Math.round(cyclesFromReference * 0.37); // Small monthly shift over time
            var dayShift = Math.round(cyclesFromReference * 11 * 0.33); // ~11 days per Saros
            
            var newMonth = ref.referenceMonth + monthShift;
            var newDay = ref.referenceDay + dayShift;
            
            // Normalize month and day
            while (newMonth > 12) {
                newMonth -= 12;
            }
            while (newMonth < 1) {
                newMonth += 12;
            }
            while (newDay > 31) {
                newDay -= 30;
            }
            while (newDay < 1) {
                newDay += 30;
            }
            
            // Determine visibility based on geographical shift
            var longitude = (cyclesFromReference * 120) % 360; // 120° shift per Saros
            var visibility = getVisibilityFromLongitude(longitude, ref.type);
            
            eclipses.push({
                type: ref.type,
                date: newDay + "." + newMonth + "." + year,
                visibility: visibility,
                sarosInfo: "Saros " + ref.sarosNumber + " (cyklus " + Math.round(cyclesFromReference) + ")"
            });
        }
    }
    
    // If no eclipses found through Saros, add statistical approximation
    if (eclipses.length === 0) {
        eclipses = getStatisticalEclipses(year);
    }
    
    // Sort by date
    eclipses.sort(function(a, b) {
        var dateA = new Date(a.date.split('.').reverse().join('-'));
        var dateB = new Date(b.date.split('.').reverse().join('-'));
        return dateA - dateB;
    });
    
    return eclipses;
}

function getVisibilityFromLongitude(longitude, type) {
    var visibilityRegions = {
        solar: [
            "Severní Amerika", "Jižní Amerika", "Evropa", "Afrika", 
            "Asie", "Austrálie", "Pacifik", "Atlantik", "Arktida", "Antarktida"
        ],
        lunar: [
            "Celá noční hemisféra", "Amerika a západní Evropa", "Evropa, Afrika, Asie",
            "Asie, Austrálie, Pacifik", "Amerika", "Evropa a Afrika"
        ]
    };
    
    var regions = type === "Sluneční" ? visibilityRegions.solar : visibilityRegions.lunar;
    var index = Math.floor(longitude / 60) % regions.length;
    
    return regions[index];
}

function getStatisticalEclipses(year) {
    // Fallback statistical method for distant years
    var eclipses = [];
    
    // On average, there are 2-3 solar and 2-3 lunar eclipses per year
    var numSolar = 2;
    var numLunar = 2;
    
    // Generate eclipses based on eclipse seasons (roughly every 6 months)
    var eclipseSeasons = [
        {month: 2 + (year % 3), type: "Sluneční"},
        {month: 5 + (year % 2), type: "Měsíční"},
        {month: 8 + (year % 3), type: "Sluneční"},
        {month: 11 + (year % 2), type: "Měsíční"}
    ];
    
    for (var i = 0; i < eclipseSeasons.length && i < 4; i++) {
        var season = eclipseSeasons[i];
        var day = 15 + ((year * 7 + i * 3) % 15) - 7; // Varies between 8-22
        
        if (day < 1) day = 1;
        if (day > 28) day = 28;
        
        eclipses.push({
            type: season.type,
            date: day + "." + season.month + "." + year,
            visibility: "Vypočítáno statisticky - zkontrolujte další zdroje",
            note: "Aproximace pro vzdálený rok"
        });
    }
    
    return eclipses;
}
    
 
    // NEW: Corrected Sidereal time calculation (USNO algorithm)
    function getSiderealTime(day, month, year, hour, minute, longitude, dstOffset) {
        if (dstOffset === undefined) dstOffset = 0;
        
        // Calculate timezone from longitude (longitude / 15°)
        var baseTimezone = Math.round(longitude / 15);
        var totalTimezone = baseTimezone + dstOffset;
        
        // Convert local time to UTC
        var utcHour = hour - totalTimezone;
        var utcMinute = minute;
        
        // Handle day overflow/underflow
        var utcDay = day;
        var utcMonth = month;
        var utcYear = year;
        
        if (utcHour < 0) {
            utcHour += 24;
            utcDay--;
            if (utcDay < 1) {
                utcMonth--;
                if (utcMonth < 1) {
                    utcMonth = 12;
                    utcYear--;
                }
                var daysInPrevMonth = [31, isLeapYear(utcYear) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                utcDay = daysInPrevMonth[utcMonth - 1];
            }
        } else if (utcHour >= 24) {
            utcHour -= 24;
            utcDay++;
            var daysInMonth = [31, isLeapYear(utcYear) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            if (utcDay > daysInMonth[utcMonth - 1]) {
                utcDay = 1;
                utcMonth++;
                if (utcMonth > 12) {
                    utcMonth = 1;
                    utcYear++;
                }
            }
        }
        
        // USNO Algorithm for Greenwich Mean Sidereal Time
        var jd0 = Math.floor(getJulianDayNumber(utcDay, utcMonth, utcYear)) + 0.5; // Midnight JD
        var H = utcHour + utcMinute / 60.0; // Hours since midnight
        var DUT = jd0 - 2451545.0; // Days since J2000.0 epoch
        var T = DUT / 36525; // Centuries since J2000.0
        
        // Greenwich Mean Sidereal Time (USNO formula)
        var GMST = 6.697375 + 0.065709824279 * DUT + 1.0027379 * H + 0.0000258 * T * T;
        GMST = GMST % 24;
        if (GMST < 0) GMST += 24;
        
        // Local Sidereal Time (add longitude in hours)
        var LST = GMST + longitude / 15;
        LST = LST % 24;
        if (LST < 0) LST += 24;
        
        // Convert GMST to h:m:s format
        var gstH = Math.floor(GMST);
        var gstM = Math.floor((GMST - gstH) * 60);
        var gstS = Math.round(((GMST - gstH) * 60 - gstM) * 60);
        
        if (gstS >= 60) { gstM++; gstS = 0; }
        if (gstM >= 60) { gstH++; gstM = 0; }
        
        // Convert LST to h:m:s format
        var lstH = Math.floor(LST);
        var lstM = Math.floor((LST - lstH) * 60);
        var lstS = Math.round(((LST - lstH) * 60 - lstM) * 60);
        
        if (lstS >= 60) { lstM++; lstS = 0; }
        if (lstM >= 60) { lstH++; lstM = 0; }
        
        return {
            gst: gstH + ":" + (gstM < 10 ? '0' : '') + gstM + ":" + (gstS < 10 ? '0' : '') + gstS,
            lst: lstH + ":" + (lstM < 10 ? '0' : '') + lstM + ":" + (lstS < 10 ? '0' : '') + lstS,
            lstDegrees: (LST * 15).toFixed(2) + "°",
            timezone: "UTC" + (totalTimezone >= 0 ? "+" : "") + totalTimezone,
            utcTime: (utcHour < 10 ? '0' : '') + utcHour + ":" + (utcMinute < 10 ? '0' : '') + utcMinute
        };
    }
    // Math type operation toggle
    function toggleMathOperation() {
        var mathType = document.getElementById('mathType').value;
        var addOp = document.getElementById('addOperation');
        var diffOp = document.getElementById('diffOperation');
        
        if (mathType === 'add') {
            addOp.style.display = 'block';
            diffOp.style.display = 'none';
        } else {
            addOp.style.display = 'none';
            diffOp.style.display = 'block';
        }
        clearDisplay();
    }

    // Main calculator functions
    function calculateDayOfWeek() {
        try {
            var dateInput = document.getElementById('dateInput');
            if (!dateInput) return;

            var dateString = dateInput.value.trim();
            if (!dateString) {
                showError("Zadejte datum v libovolném formátu");
                return;
            }

            var parsed = parseDate(dateString);
            if (!parsed) {
                showError("Neplatný formát data. Zkuste: 1.1.1, 15.3.44, 1/3/89, 01031989");
                return;
            }

            var error = validateDate(parsed.day, parsed.month, parsed.year);
            if (error) {
                showError(error);
                return;
            }

            showLoading();
            setTimeout(function() {
                var result = getDayOfWeek(parsed.day, parsed.month, parsed.year);
                showResult(result);
            }, 300);
        } catch (e) {
            showError("Došlo k chybě při výpočtu");
        }
    }
    
    function calculateYearFinder() {
        var day = parseInt(document.getElementById('yearFinderDay').value);
        var month = parseInt(document.getElementById('yearFinderMonth').value);
        var dayOfWeek = parseInt(document.getElementById('yearFinderDayOfWeek').value);
        
        if (!day || !month || isNaN(dayOfWeek)) {
            showError("Vyplňte všechna pole");
            return;
        }
        
        if (day < 1 || day > 31 || month < 1 || month > 12) {
            showError("Neplatný den nebo měsíc");
            return;
        }
        
        showLoading();
        setTimeout(function() {
            var years = [];
            var dayNames = ["neděle", "pondělí", "úterý", "středa", "čtvrtek", "pátek", "sobota"];
            
            for (var year = 2000; year <= 2100; year++) {
                var daysInMonth = [31, isLeapYear(year) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                if (day <= daysInMonth[month - 1]) {
                    var me = month, rr = year;
                    if (month < 3) {
                        me = month + 12;
                        rr = year - 1;
                    }
                    var k = rr % 100;
                    var j = Math.floor(rr / 100);
                    var h = ((day + Math.floor((13 * (me + 1)) / 5) + k + Math.floor(k / 4) + Math.floor(j / 4) - (2 * j)) % 7 + 7) % 7;
                    var calculatedDayOfWeek = (h + 6) % 7;
                    
                    if (calculatedDayOfWeek === dayOfWeek) {
                        years.push(year + (isLeapYear(year) ? ' <strong>(přestupný)</strong>' : ''));
                    }
                }
            }
            
            if (years.length > 0) {
                showResult('<strong>' + day + '.' + month + '. připadá na ' + dayNames[dayOfWeek] + ' v letech:</strong><br><small>' + years.join(', ') + '</small>');
            } else {
                showResult('Pro zadané parametry nebyli nalezeni žádné roky v období 2000-2100');
            }
        }, 300);
    }
    
    function calculateConverter() {
        var dateStr = document.getElementById('converterDate').value.trim();
        var type = document.getElementById('converterType').value;
        
        if (!dateStr) {
            showError("Zadejte datum");
            return;
        }
        
        var parsed = parseDate(dateStr);
        if (!parsed) {
            showError("Neplatný formát data");
            return;
        }
        
        showLoading();
        setTimeout(function() {
            var result = '';
            if (type === 'gregorian') {
                var julianDay = getJulianDayNumber(parsed.day, parsed.month, parsed.year);
                var julianDate = getDateFromJulianDay(julianDay, true);
                var julianJDN = getJulianDayNumber(parsed.day, parsed.month, parsed.year, true);
                var rozdil = julianDay - julianJDN;

                result = '<strong>Gregoriánský:</strong> ' + parsed.day + '.' + parsed.month + '.' + parsed.year + 
                        '<br><strong>Juliánský:</strong> ' + julianDate.day + '.' + julianDate.month + '.' + julianDate.year +
                        '<br><small>Rozdíl: ' + rozdil + ' dní</small>';
            } else {
                var julianDay = getJulianDayNumber(parsed.day, parsed.month, parsed.year, true);
                var gregorianDate = getDateFromJulianDay(julianDay, false);
                var gregJDN = getJulianDayNumber(parsed.day, parsed.month, parsed.year);
                var rozdil = gregJDN - julianDay;

                result = '<strong>Juliánský:</strong> ' + parsed.day + '.' + parsed.month + '.' + parsed.year + 
                        '<br><strong>Gregoriánský:</strong> ' + gregorianDate.day + '.' + gregorianDate.month + '.' + gregorianDate.year +
                        '<br><small>Rozdíl: ' + rozdil + ' dní</small>';
            }
            showResult(result);
        }, 300);
    }
    
    function calculateEaster() {
        var year = parseInt(document.getElementById('easterYear').value);
        
        if (!year || year < 1 || year > 9999) {
            showError("Zadejte platný rok (1-9999)");
            return;
        }
        
        showLoading();
        setTimeout(function() {
            var easter = getEasterDate(year);
            var ashWednesday = addDays(easter, -46);
            var palmSunday = addDays(easter, -7);
            var goodFriday = addDays(easter, -2);
            var easterMonday = addDays(easter, 1);
            var whiteSunday = addDays(easter, 7);
            
            var result = '<strong>Velikonoční svátky ' + year + ':</strong><br>' +
                        '<small>Popeleční středa: ' + formatDate(ashWednesday) + '<br>' +
                        'Květná neděle: ' + formatDate(palmSunday) + '<br>' +
                        'Velký pátek: ' + formatDate(goodFriday) + '<br>' +
                        '<strong>Velikonoční neděle: ' + formatDate(easter) + '</strong><br>' +
                        'Velikonoční pondělí: ' + formatDate(easterMonday) + '<br>' +
                        'Bílá neděle: ' + formatDate(whiteSunday) + '</small>';
            
            showResult(result);
        }, 300);
    }
    
    function calculateMoonPhase() {
        var dateStr = document.getElementById('moonDate').value.trim();
        
        if (!dateStr) {
            showError("Zadejte datum");
            return;
        }
        
        var parsed = parseDate(dateStr);
        if (!parsed) {
            showError("Neplatný formát data");
            return;
        }
        
        showLoading();
        setTimeout(function() {
            var moonAge = getMoonAge(parsed.day, parsed.month, parsed.year);
            var phase = getMoonPhase(moonAge);
            var emoji = getMoonEmoji(moonAge);
            var illumination = Math.abs(Math.cos((moonAge / 29.53058867) * 2 * Math.PI - Math.PI)) * 100;
            
            var result = '<strong>' + parsed.day + '.' + parsed.month + '.' + parsed.year + '</strong><br>' +
                        emoji + ' <strong>' + phase + '</strong><br>' +
                        '<small>Stáří Měsíce: ' + moonAge.toFixed(1) + ' dní<br>' +
                        'Osvětlení: ' + illumination.toFixed(1) + '%</small>';
            
            showResult(result);
        }, 300);
    }
    
    function calculateDateMath() {
        var mathType = document.getElementById('mathType').value;
        
        if (mathType === 'add') {
            var dateStr = document.getElementById('mathDate1').value.trim();
            var days = parseInt(document.getElementById('mathDays').value);
            
            if (!dateStr || isNaN(days)) {
                showError("Zadejte datum a počet dní");
                return;
            }
            
            var parsed = parseDate(dateStr);
            if (!parsed) {
                showError("Neplatný formát data");
                return;
            }
            
            showLoading();
            setTimeout(function() {
                var resultDate = addDays(parsed, days);
                var dayOfWeek = getDayOfWeekSimple(resultDate.day, resultDate.month, resultDate.year);
                
                var operation = days >= 0 ? 'přičtení' : 'odečtení';
                var result = '<strong>' + parsed.day + '.' + parsed.month + '.' + parsed.year + 
                           ' ' + (days >= 0 ? '+' : '') + days + ' dní:</strong><br>' +
                           '<strong>' + resultDate.day + '.' + resultDate.month + '.' + resultDate.year + '</strong><br>' +
                           '<small>' + dayOfWeek + '</small>';
                
                showResult(result);
            }, 300);
        } else {
            var dateStr1 = document.getElementById('mathDate2').value.trim();
            var dateStr2 = document.getElementById('mathDate3').value.trim();
            
            if (!dateStr1 || !dateStr2) {
                showError("Zadejte obě data");
                return;
            }
            
            var parsed1 = parseDate(dateStr1);
            var parsed2 = parseDate(dateStr2);
            
            if (!parsed1 || !parsed2) {
                showError("Neplatný formát data");
                return;
            }
            
            showLoading();
            setTimeout(function() {
                var jd1 = getJulianDayNumber(parsed1.day, parsed1.month, parsed1.year);
                var jd2 = getJulianDayNumber(parsed2.day, parsed2.month, parsed2.year);
                var diff = Math.abs(jd2 - jd1);
                
                var years = Math.floor(diff / 365.25);
                var weeks = Math.floor(diff / 7);
                var remainingDays = diff % 7;
                
                var result = '<strong>Rozdíl mezi daty:</strong><br>' +
                           parsed1.day + '.' + parsed1.month + '.' + parsed1.year + ' a ' +
                           parsed2.day + '.' + parsed2.month + '.' + parsed2.year + '<br>' +
                           '<strong>' + diff + ' dní</strong><br>' +
                           '<small>' + weeks + ' týdnů a ' + remainingDays + ' dní<br>' +
                           'Přibližně ' + years + ' let</small>';
                
                showResult(result);
            }, 300);
        }
    }

    // NEW: Calculate sun events
 
function calculateSunEventsFunc() {
    var dateStr = document.getElementById('sunEventsDate').value.trim();
    var latitude = parseFloat(document.getElementById('latitude').value);
    var longitude = parseFloat(document.getElementById('longitude').value);
    
    if (!dateStr) {
        showError("Zadejte datum");
        return;
    }
    
    if (isNaN(latitude) || isNaN(longitude)) {
        showError("Zadejte platné souřadnice");
        return;
    }
    
    if (latitude < -90 || latitude > 90) {
        showError("Zeměpisná šířka musí být mezi -90 a 90 stupni");
        return;
    }
    
    if (longitude < -180 || longitude > 180) {
        showError("Zeměpisná délka musí být mezi -180 a 180 stupni");
        return;
    }
    
    var parsed = parseDate(dateStr);
    if (!parsed) {
        showError("Neplatný formát data");
        return;
    }
    
    showLoading();
    setTimeout(function() {
        var sunEvents = calculateSunEvents(parsed.day, parsed.month, parsed.year, latitude, longitude);
        
        var result = '<strong>Sluneční události ' + parsed.day + '.' + parsed.month + '.' + parsed.year + '</strong><br>';
        
        if (sunEvents.polarNight) {
            result += '<strong>🌑 Polární noc</strong><br>' + 
                     '<small>Na těchto souřadnicích slunce nevychází<br>' +
                     'Deklinace Slunce: ' + sunEvents.declination + '</small>';
        } else if (sunEvents.polarDay) {
            result += '<strong>🌞 Polární den</strong><br>' +
                     '<small>Na těchto souřadnicích slunce nezapadá<br>' +
                     'Deklinace Slunce: ' + sunEvents.declination + '</small>';
        } else {
            result += '<strong>🌅 Východ slunce:</strong> ' + sunEvents.sunrise + '<br>' +
                     '<strong>🌇 Západ slunce:</strong> ' + sunEvents.sunset + '<br>' +
                     '<strong>⏱️ Délka dne:</strong> ' + sunEvents.dayLength + '<br>' +
                     '<small>📍 Souřadnice: ' + latitude.toFixed(4) + '°, ' + longitude.toFixed(4) + '°<br>' +
                     '☀️ Deklinace Slunce: ' + sunEvents.declination + '<br>';
                     
            if (sunEvents.eqTime) {
                result += '⏰ Rovnice času: ' + sunEvents.eqTime + '<br>';
            }
            if (sunEvents.timezone) {
                result += '🕐 Časové pásmo: ' + sunEvents.timezone;
            }
            result += '</small>';
        }
        
        showResult(result);
    }, 300);
}
    
    // NEW: Calculate planet positions
    function calculatePlanetPositionsFunc() {
        var dateStr = document.getElementById('planetDate').value.trim();
        
        if (!dateStr) {
            showError("Zadejte datum");
            return;
        }
        
        var parsed = parseDate(dateStr);
        if (!parsed) {
            showError("Neplatný formát data");
            return;
        }
        
        showLoading();
        setTimeout(function() {
        	
// Get time inputs
var timeStr = document.getElementById('planetTime').value || "00:00";
var timezone = parseInt(document.getElementById('planetTimezone').value) || 0;
var timeParts = timeStr.split(':');
var hour = parseInt(timeParts[0]) || 0;
var minute = parseInt(timeParts[1]) || 0;

var planets = getPlanetPositions(parsed.day, parsed.month, parsed.year, hour, minute, timezone);
            
 var result = '<strong>Pozice planet ' + parsed.day + '.' + parsed.month + '.' + parsed.year + '</strong><br>' +
            '<small>Čas: ' + timeStr + ' (UTC' + (timezone >= 0 ? '+' : '') + timezone + ')</small><br><br>';

for (var i = 0; i < planets.length; i++) {
    var planet = planets[i];
    result += '<strong>' + planet.name + '</strong><br>' +
             '📍 ' + planet.position + '<br>' +
             '📐 Elongace: ' + planet.elongation + '<br>' +
             '⭐ Souhvězdí: ' + planet.constellation + '<br>' +
             '✨ Jasnost: ' + planet.magnitude + '<br>' +
             '👁️ ' + planet.visibility + '<br>' +
             '<small>' + planet.type + '</small><br><br>';
}
            showResult(result);
        }, 300);
    }
    
    // NEW: Calculate eclipses
  function calculateEclipsesFunc() {
    var year = parseInt(document.getElementById('eclipsesYear').value);
    
    if (!year || year < 1000 || year > 3000) {
        showError("Zadejte platný rok (1000-3000)");
        return;
    }
    
    showLoading();
    setTimeout(function() {
        var eclipses = getEclipses(year);
        var currentYear = new Date().getFullYear();
        
        var result = '<strong>Zatmění v roce ' + year + ':</strong><br>';
        
        if (eclipses.length === 0) {
            result += '<small>V tomto roce nebudou žádná významná zatmění viditelná.</small>';
        } else {
            result += '<small>';
            
            for (var i = 0; i < eclipses.length; i++) {
                var eclipse = eclipses[i];
                result += '<strong>' + eclipse.type + ' zatmění:</strong> ' + eclipse.date + '<br>';
                result += 'Viditelnost: ' + eclipse.visibility + '<br>';
                
                if (eclipse.sarosInfo) {
                    result += '<em>' + eclipse.sarosInfo + '</em><br>';
                }
                if (eclipse.note) {
                    result += '<em>' + eclipse.note + '</em><br>';
                }
                
                result += '<br>';
            }
            
            // Add accuracy note
            if (Math.abs(year - currentYear) <= 10) {
                result += '<em>📍 Přesná data pro roky blízké současnosti</em>';
            } else if (Math.abs(year - currentYear) <= 50) {
                result += '<em>🔬 Aproximace pomocí Saros cyklů</em>';
            } else {
                result += '<em>📊 Statistická aproximace - ověřte v dalších zdrojích</em>';
            }
            
            result += '</small>';
        }
        
        showResult(result);
    }, 300);
}
    
    // NEW: Calculate sidereal time
      // NEW: Calculate sidereal time
    function calculateSiderealTimeFunc() {
        var dateStr = document.getElementById('siderealDate').value.trim();
        var timeStr = document.getElementById('siderealTime').value;
        var longitude = parseFloat(document.getElementById('siderealLongitude').value);
        var dstOffset = parseInt(document.getElementById('siderealDST').value) || 0;
        
        if (!dateStr || !timeStr) {
            showError("Zadejte datum a čas");
            return;
        }
        
        if (isNaN(longitude)) {
            showError("Zadejte platnou zeměpisnou délku");
            return;
        }
        
        var parsed = parseDate(dateStr);
        if (!parsed) {
            showError("Neplatný formát data");
            return;
        }
        
        var timeParts = timeStr.split(':');
        var hour = parseInt(timeParts[0]);
        var minute = parseInt(timeParts[1]);
        
        showLoading();
        setTimeout(function() {
            var sidereal = getSiderealTime(parsed.day, parsed.month, parsed.year, hour, minute, longitude, dstOffset);
            
            var result = '<strong>Hvězdný čas ' + parsed.day + '.' + parsed.month + '.' + parsed.year + '</strong><br>' +
                        '<strong>Místní čas:</strong> ' + hour + ':' + (minute < 10 ? '0' : '') + minute + ' (' + sidereal.timezone + ')<br>' +
                        '<strong>UTC čas:</strong> ' + sidereal.utcTime + '<br>' +
                        '<strong>Greenwichský hvězdný čas:</strong> ' + sidereal.gst + '<br>' +
                        '<strong>Místní hvězdný čas:</strong> ' + sidereal.lst + '<br>' +
                        '<small>LST ve stupních: ' + sidereal.lstDegrees + '<br>' +
                        'Zeměpisná délka: ' + longitude.toFixed(4) + '°<br>' +
                        'Časové pásmo: ' + Math.round(longitude / 15) + (dstOffset ? ' + letní čas' : '') + '</small>';
            
            showResult(result);
        }, 300);
    }

    // Universal safe tap/click handler
    function addSafeTap(selector, callback) {
        var items = document.querySelectorAll(selector);
        for (var i = 0; i < items.length; i++) {
            (function(item) {
                let touchMoved = false;
                item.addEventListener('touchstart', function(e) {
                    touchMoved = false;
                });
                item.addEventListener('touchmove', function(e) {
                    touchMoved = true;
                });
                item.addEventListener('touchend', function(e) {
                    if (!touchMoved) callback(item, e);
                });
                item.addEventListener('click', function(e) {
                    callback(item, e);
                });
            })(items[i]);
        }
    }

    // Application initialization
    function initializeApp() {
        try {
            var savedTheme = getStoredTheme();
            if (savedTheme) {
                document.body.className = savedTheme;
            }
            
            // Menu button
            var menuButton = document.getElementById('menuButton');
            if (menuButton) {
                menuButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMenu();
                });
                menuButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleMenu();
                });
            }
            
            // Menu items
            addSafeTap('#dayOfWeekMenu', function(item) {
                showCalculator('dayOfWeek');
            });
            
            addSafeTap('#calculatorsMenu', function(item, e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                toggleSubmenu('calculatorsSubmenu');
            });

            addSafeTap('#astronomyMenu', function(item, e) {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                toggleSubmenu('astronomySubmenu');
            });
            
 // Calculator menu items
            var calcItems = document.querySelectorAll('[data-calculator]');
            for (var i = 0; i < calcItems.length; i++) {
                (function(item) {
                    var calc = item.getAttribute('data-calculator');
                    let touchMoved = false;
                    item.addEventListener('touchstart', function(e) {
                        touchMoved = false;
                    });
                    item.addEventListener('touchmove', function(e) {
                        touchMoved = true;
                    });
                    item.addEventListener('touchend', function(e) {
                        if (!touchMoved) showCalculator(calc);
                    });
                    item.addEventListener('click', function() {
                        showCalculator(calc);
                    });
                })(calcItems[i]);
            }
            
            // Back buttons
            addSafeTap('[data-back]', function(item) {
                showCalculator('dayOfWeek');
            });
            
            // Version button
            addSafeTap('#versionButton', function(item) {
                showVersion();
            });
            
            // Theme items
            addSafeTap('.theme-item', function(item) {
                var theme = item.getAttribute('data-theme') || '';
                changeTheme(theme);
            });
            
            // Link items
            addSafeTap('[data-link]', function(item) {
                var link = item.getAttribute('data-link');
                openLink(link);
            });
            
            // Input focus tracking
            var inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="time"]');
            for (var i = 0; i < inputs.length; i++) {
                (function(input) {
                    input.addEventListener('focus', function() {
                        activeInput = input;
                    });
                    input.addEventListener('input', clearDisplay);
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' || e.keyCode === 13) {
                            e.preventDefault();
                            switch(currentCalculator) {
                                case 'dayOfWeek':
                                    calculateDayOfWeek();
                                    break;
                                case 'yearFinder':
                                    calculateYearFinder();
                                    break;
                                case 'calendarConverter':
                                    calculateConverter();
                                    break;
                                case 'easter':
                                    calculateEaster();
                                    break;
                                case 'moonPhase':
                                    calculateMoonPhase();
                                    break;
                                case 'dateMath':
                                    calculateDateMath();
                                    break;
                                case 'sunEvents':
                                    calculateSunEventsFunc();
                                    break;
                                case 'planetPositions':
                                    calculatePlanetPositionsFunc();
                                    break;
                                case 'eclipses':
                                    calculateEclipsesFunc();
                                    break;
                                case 'siderealTime':
                                    calculateSiderealTimeFunc();
                                    break;
                            }
                        }
                    });
                })(inputs[i]);
            }
            
            // Calculate buttons
            var calculateBtn = document.getElementById('calculateBtn');
            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateDayOfWeek);
                calculateBtn.addEventListener('touchend', calculateDayOfWeek);
            }
            
            var yearFinderBtn = document.getElementById('yearFinderBtn');
            if (yearFinderBtn) {
                yearFinderBtn.addEventListener('click', calculateYearFinder);
                yearFinderBtn.addEventListener('touchend', calculateYearFinder);
            }
            
            var converterBtn = document.getElementById('converterBtn');
            if (converterBtn) {
                converterBtn.addEventListener('click', calculateConverter);
                converterBtn.addEventListener('touchend', calculateConverter);
            }
            
            var easterBtn = document.getElementById('easterBtn');
            if (easterBtn) {
                easterBtn.addEventListener('click', calculateEaster);
                easterBtn.addEventListener('touchend', calculateEaster);
            }
            
            var moonBtn = document.getElementById('moonBtn');
            if (moonBtn) {
                moonBtn.addEventListener('click', calculateMoonPhase);
                moonBtn.addEventListener('touchend', calculateMoonPhase);
            }
            
            var dateMathBtn = document.getElementById('dateMathBtn');
            if (dateMathBtn) {
                dateMathBtn.addEventListener('click', calculateDateMath);
                dateMathBtn.addEventListener('touchend', calculateDateMath);
            }
            
            // NEW: Astronomy calculator buttons
            var sunEventsBtn = document.getElementById('sunEventsBtn');
if (sunEventsBtn) {
    sunEventsBtn.addEventListener('click', calculateSunEventsFunc);
    sunEventsBtn.addEventListener('touchend', calculateSunEventsFunc);
}
            
            var planetBtn = document.getElementById('planetBtn');
            if (planetBtn) {
                planetBtn.addEventListener('click', calculatePlanetPositionsFunc);
                planetBtn.addEventListener('touchend', calculatePlanetPositionsFunc);
            }
            
            var eclipsesBtn = document.getElementById('eclipsesBtn');
            if (eclipsesBtn) {
                eclipsesBtn.addEventListener('click', calculateEclipsesFunc);
                eclipsesBtn.addEventListener('touchend', calculateEclipsesFunc);
            }
            
            var siderealBtn = document.getElementById('siderealBtn');
            if (siderealBtn) {
                siderealBtn.addEventListener('click', calculateSiderealTimeFunc);
                siderealBtn.addEventListener('touchend', calculateSiderealTimeFunc);
            }
            
            // Math type selector
            var mathType = document.getElementById('mathType');
            if (mathType) {
                mathType.addEventListener('change', toggleMathOperation);
            }
            
            // Example items for day of week calculator
            var exampleItems = document.querySelectorAll('[data-date]');
            for (var i = 0; i < exampleItems.length; i++) {
                (function(item) {
                    var date = item.getAttribute('data-date');
                    let touchMoved = false;
                    item.addEventListener('touchstart', function(e) {
                        touchMoved = false;
                    });
                    item.addEventListener('touchmove', function(e) {
                        touchMoved = true;
                    });
                    item.addEventListener('touchend', function(e) {
                        if (!touchMoved) fillDate(date);
                    });
                    item.addEventListener('click', function() {
                        fillDate(date);
                    });
                })(exampleItems[i]);
            }
            
            // Close menu when clicking outside
            function closeMenuOutside(event) {
                var menuContainer = document.querySelector('.menu-container');
                var dropdown = document.getElementById('menuDropdown');
                
                if (menuContainer && dropdown && !menuContainer.contains(event.target) && isMenuOpen) {
                    dropdown.classList.remove('show');
                    isMenuOpen = false;
                }
            }
            
            document.addEventListener('click', closeMenuOutside);
            document.addEventListener('touchstart', closeMenuOutside);
            
            // Prevent double tap zoom
            var lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                var now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Handle orientation change
            function handleOrientationChange() {
                setTimeout(function() {
                    var dropdown = document.getElementById('menuDropdown');
                    if (dropdown && isMenuOpen) {
                        dropdown.classList.remove('show');
                        setTimeout(function() {
                            dropdown.classList.add('show');
                        }, 50);
                    }
                }, 100);
            }
            
            if (window.addEventListener) {
                window.addEventListener('orientationchange', handleOrientationChange);
                window.addEventListener('resize', handleOrientationChange);
            }
            
            // Initialize current date for inputs
            var today = new Date();
            var todayStr = today.getDate() + '.' + (today.getMonth() + 1) + '.' + today.getFullYear();
            
            // Set default values for some inputs
            var sunEventsDate = document.getElementById('sunEventsDate');
            if (sunEventsDate && !sunEventsDate.value) {
                sunEventsDate.placeholder = todayStr;
            }
            
            var planetDate = document.getElementById('planetDate');
            if (planetDate && !planetDate.value) {
                planetDate.placeholder = todayStr;
            }
            
            var siderealDate = document.getElementById('siderealDate');
            if (siderealDate && !siderealDate.value) {
                siderealDate.placeholder = todayStr;
            }
            var siderealTime = document.getElementById('siderealTime');
            if (siderealTime && !siderealTime.value) {
                var currentHour = today.getHours();
                var currentMinute = today.getMinutes();
                siderealTime.value = (currentHour < 10 ? '0' : '') + currentHour + ':' + (currentMinute < 10 ? '0' : '') + currentMinute;
            }
            
            // Set default DST for current season (simplified)
            var siderealDST = document.getElementById('siderealDST');
            if (siderealDST) {
                var currentMonth = today.getMonth() + 1; // 1-12
                var isDST = (currentMonth >= 4 && currentMonth <= 10); // Rough DST period
                siderealDST.value = isDST ? "1" : "0";
            }
            
            
        } catch (error) {
            console.log('Initialization error:', error);
        }
    }
    
    // Initialize app when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
        initializeApp();
    }
    
})();
</script>
</body>
</html>